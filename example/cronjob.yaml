apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-bdrtoken-gen
  namespace: vault
spec:
  schedule: "0 1-23/7 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: vault-bdrtoken-gen
          containers:
          - name: vault-bdrtoken-gen
            image: knanao/vault-bdrtoken-gen:v0.1.0
            imagePullPolicy: IfNotPresent
            args:
            - --kubernetes-auth-role=vault-bdrtoken-gen
            - --batch-token-role=failover-handler
            - --bucket-url=gs://vault-bdrtoken
            env:
            - name: VAULT_ADDR
              value: ${VAULT_ADDR}
            - name: TZ
              value: Asia/Tokyo
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    # For GKE
    # https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity
    iam.gke.io/gcp-service-account: vault-bdrtoken-gen@${PROJECT_ID}.iam.gserviceaccount.com
    # For EKS
    # https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html
    #eks.amazonaws.com/role-arn: arn:aws:iam::{ACCOUNT_ID}:role/vault-bdrtoken-gen
  name: vault-bdrtoken-gen
  namespace: vault
